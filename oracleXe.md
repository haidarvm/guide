#### installation #####

#official guide
https://www.youtube.com/watch?v=XB1ZakqiTa8

#download oracle xe from oracle link

#download preinstall
curl -o oracle-database-preinstall-18c-1.0-1.el7.x86_64.rpm https://yum.oracle.com/repo/OracleLinux/OL7/latest/x86_64/getPackage/oracle-database-preinstall-18c-1.0-1.el7.x86_64.rpm

#download compat lib from el7
wget http://mirror.centos.org/centos/7/os/x86_64/Packages/compat-libstdc++-33-3.2.3-72.el7.x86_64.rpm
wget http://mirror.centos.org/centos/7/os/x86_64/Packages/compat-libcap1-1.10-7.el7.x86_64.rpm

#dnf install all packages
dnf install -y compat-libstdc++-33-3.2.3-72.el7.x86_64.rpm compat-libcap1-1.10-7.el7.x86_64.rpm libnsl libnsl2
dnf install -y oracle-database-preinstall-18c-1.0-1.el7.x86_64.rpm
dnf install -y oracle-database-xe-18c-1.0-1.x86_64.rpm 

#run configure
/etc/init.d/oracle-xe configure

#export home & sid
export ORACLE_SID=XE
export ORAENV_ASK=NO 
export ORACLE_BASE=/opt/oracle/
export ORACLE_HOME=$ORACLE_BASE/product/18c/dbhomeXE
PATH=/usr/sbin:$PATH:$ORACLE_HOME/bin


# input oracle_home
/opt/oracle/product/18c/dbhomeXE

#run sqlplus
sqlplus sys/password@//localhost:1521/XE as sysdba

#promt password
sqlplus sys@\"localhost:1521/XE\" as sysdba

#show pdb
select name from v$pdbs;

#check version
SELECT banner FROM v$version WHERE ROWNUM = 1;

#create new user
alter user annas identified by "A1l4h38b1S3002" account unlock;  
alter session set "_ORACLE_SCRIPT"=true;
CREATE USER haidar IDENTIFIED BY "apassword";
GRANT CREATE SESSION TO haidar;
GRANT CONNECT TO haidar;
grant all privileges to haidar;

#create table example
CREATE TABLE persons(
    person_id NUMBER GENERATED BY DEFAULT AS IDENTITY,
    first_name VARCHAR2(50) NOT NULL,
    last_name VARCHAR2(50) NOT NULL,
    PRIMARY KEY(person_id)
);

#login em
http://localhost:5500/em

#external access
select dbms_xdb_config.gethttpsport() from dual;
EXEC DBMS_XDB.SETLISTENERLOCALACCESS(FALSE);


#on restart linux
su - oracle
sqlplus /nolog
SQL> conn / as sysdba
SQL> startup
lsnrctl start #taro bawah mungkin

#restart db
shutdown immediate
startup

#list all users
SELECT username FROM dba_users;

#list all tables from user
SELECT table_name FROM user_tables;

#### install apex #####
### use xepdb ###


1. copy apex to oracle home
unzip apex_18.2.zip
cd apex

sqlplus /nolog
SQL> SHOW PARAMETER PFILE;
SQL> SHOW PARAMETER MEMORY_TARGET
SQL> ALTER SYSTEM SET MEMORY_TARGET='900M' SCOPE=spfile;
SQL> SHUTDOWN
SQL> SHUTDOWN ABORT
 
SQL> STARTUP

SQL> conn sys as sysdba

SQL> ALTER USER ANONYMOUS ACCOUNT UNLOCK;
SQL> ALTER SESSION SET CONTAINER=XEPDB1;
SQL> exec DBMS_XDB_CONFIG.SETHTTPSPORT(5502);
SQL> EXEC DBMS_XDB.SETLISTENERLOCALACCESS(FALSE);
SQL> DBMS_XDB_CONFIG.SETGLOBALPORTENABLED(true);
     
ORA-00838: Specified value of MEMORY_TARGET is too small, needs to be at least 732M

create pfile='/tmp/pfile.bac' from spfile;
mount -t tmpfs shmfs -o size=5g /dev/shm
#fstab
tmpfs    /dev/shm   tmpfs   size=4096m  0 0

#change to 900M
sqlplus / as sysdba
SQL> startup pfile=/tmp/pfile.bac
SQL>@apex_rest_config.sql

#### install end apex #####

### INSTALL ORDS ###
service name xepdb1
java -jar ords.war setup --database xepdb1
administrator is sys
Enter the APEX static resources location:

java -jar ords.war install advanced
java -jar ords.war setup
java -jar ords.war configdir /opt/oracle/product/18c/dbhomeXE/ords/conf

SQL > ALTER USER APEX_PUBLIC_USER ACCOUNT UNLOCK
ALTER USER ORDS_PUBLIC_USER  ACCOUNT UNLOCK;

#export pump
sqlplus / AS SYSDBA
SQL> CREATE OR REPLACE DIRECTORY DUMP_DIR AS '/home/oracle/dump';
SQL> GRANT READ, WRITE ON DIRECTORY DUMP_DIR TO SYSTEM;
mkdir /home/oracle/dump

#export and prompt username: / as sysdba
expdp dumpfile=haidar_schema.dmp logfile=haidar_schema.log directory=dump_dir schemas=haidar

#import and prompt username: / as sysdba
remap_schema=znb:ecommerce
impdp directory=dump_dir dumpfile=haidar_schema.dmp logfile=haidar_import.log remap_schema=znb:ecommerce
impdp \"sys/password@//haidar.tech:1521/xepdb1 as sysdba\"  directory=dump_dir dumpfile=znb_reg_schema.dmp logfile=haidar_import.log remap_schema=znb:ecommerce

#export using sqldeveloper
export use tools database export
import use database copy 